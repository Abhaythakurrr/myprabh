<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with {{ prabh_name }} - MyPrabh</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <script src="{{ url_for('static', filename='js/snow-effects.js') }}" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Dancing+Script:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #ffeef8, #f0f8ff, #fff0f8);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            overflow: hidden;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .floating-hearts {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        .heart {
            position: absolute;
            color: rgba(255, 182, 193, 0.3);
            font-size: 20px;
            animation: floatUp 8s linear infinite;
        }
        
        @keyframes floatUp {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }
        
        .chat-container {
            max-width: 900px;
            margin: 0 auto;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 0;
            box-shadow: 0 0 50px rgba(255, 105, 180, 0.1);
            position: relative;
            z-index: 10;
        }
        .chat-header {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 240, 248, 0.95));
            backdrop-filter: blur(20px);
            padding: 25px;
            border-bottom: 1px solid rgba(255, 182, 193, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 20px rgba(255, 105, 180, 0.1);
            position: relative;
        }
        
        .chat-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #ff69b4, #ff1493, #ff69b4);
            background-size: 200% 100%;
            animation: shimmer 3s ease-in-out infinite;
        }
        
        @keyframes shimmer {
            0%, 100% { background-position: -200% 0; }
            50% { background-position: 200% 0; }
        }
        .prabh-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .prabh-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #ff69b4, #ff1493, #ff69b4);
            background-size: 200% 200%;
            animation: gradientPulse 4s ease-in-out infinite;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
            box-shadow: 0 8px 25px rgba(255, 105, 180, 0.3);
            border: 3px solid rgba(255, 255, 255, 0.8);
            position: relative;
        }
        
        .prabh-avatar::after {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            z-index: -1;
            opacity: 0.3;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes gradientPulse {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.3; }
            50% { transform: scale(1.1); opacity: 0.1; }
        }
        .prabh-details h2 {
            margin: 0;
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.4rem;
            font-weight: 600;
            font-family: 'Dancing Script', cursive;
        }
        .prabh-details p {
            margin: 5px 0 0 0;
            color: rgba(255, 105, 180, 0.8);
            font-size: 0.95rem;
            font-style: italic;
        }
        .chat-actions {
            display: flex;
            gap: 10px;
        }
        .action-btn {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 105, 180, 0.5);
            color: #ff69b4;
            padding: 10px 18px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(255, 105, 180, 0.1);
        }
        
        .action-btn:hover {
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 105, 180, 0.3);
            border-color: transparent;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .message {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            max-width: 80%;
            animation: fadeInUp 0.3s ease;
        }
        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            flex-shrink: 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.8);
        }
        
        .message.user .message-avatar {
            background: linear-gradient(135deg, #87ceeb, #4682b4);
            color: white;
        }
        
        .message.prabh .message-avatar {
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            color: white;
            animation: heartbeat 2s ease-in-out infinite;
        }
        
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .message-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 18px 22px;
            border-radius: 25px;
            box-shadow: 0 8px 25px rgba(255, 105, 180, 0.15);
            position: relative;
            border: 1px solid rgba(255, 182, 193, 0.2);
        }
        
        .message.user .message-content {
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            color: white;
            box-shadow: 0 8px 25px rgba(255, 105, 180, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .message.prabh .message-content {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 240, 248, 0.95));
            backdrop-filter: blur(15px);
        }
        .message-text {
            margin: 0;
            line-height: 1.5;
        }
        .message-time {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 5px;
        }
        .typing-indicator {
            display: none;
            align-items: center;
            gap: 12px;
            max-width: 80%;
            animation: fadeInUp 0.3s ease;
        }
        .typing-dots {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 18px 25px;
            border-radius: 25px;
            box-shadow: 0 8px 25px rgba(255, 105, 180, 0.15);
            display: flex;
            gap: 6px;
            border: 1px solid rgba(255, 182, 193, 0.2);
        }
        
        .typing-dot {
            width: 10px;
            height: 10px;
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            border-radius: 50%;
            animation: typingDot 1.4s infinite;
            box-shadow: 0 2px 8px rgba(255, 105, 180, 0.3);
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typingDot {
            0%, 60%, 100% { opacity: 0.3; transform: scale(0.8); }
            30% { opacity: 1; transform: scale(1); }
        }
        .chat-input-container {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 240, 248, 0.95));
            backdrop-filter: blur(20px);
            padding: 25px;
            border-top: 1px solid rgba(255, 182, 193, 0.2);
            box-shadow: 0 -8px 25px rgba(255, 105, 180, 0.1);
            position: relative;
        }
        
        .chat-input-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, #ff69b4, transparent);
        }
        .chat-input-wrapper {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }
        .chat-input {
            flex: 1;
            border: 2px solid rgba(255, 182, 193, 0.3);
            border-radius: 30px;
            padding: 18px 25px;
            font-size: 1rem;
            resize: none;
            max-height: 120px;
            min-height: 55px;
            font-family: inherit;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }
        
        .chat-input:focus {
            outline: none;
            border-color: #ff69b4;
            box-shadow: 0 0 0 4px rgba(255, 105, 180, 0.15), 0 8px 25px rgba(255, 105, 180, 0.1);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .chat-input::placeholder {
            color: rgba(255, 105, 180, 0.6);
            font-style: italic;
        }
        .send-button {
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            color: white;
            border: none;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            box-shadow: 0 8px 25px rgba(255, 105, 180, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .send-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }
        
        .send-button:hover {
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 12px 35px rgba(255, 105, 180, 0.4);
        }
        
        .send-button:hover::before {
            left: 100%;
        }
        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .empty-chat {
            text-align: center;
            color: rgba(255, 105, 180, 0.8);
            padding: 60px 20px;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            margin: 20px;
            border: 1px solid rgba(255, 182, 193, 0.2);
        }
        
        .empty-chat-icon {
            font-size: 4rem;
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
            animation: heartPulse 2s ease-in-out infinite;
        }
        
        .empty-chat h3 {
            font-family: 'Dancing Script', cursive;
            font-size: 1.8rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        @keyframes heartPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        /* Enhanced UI Components */
        .action-btn {
            position: relative;
        }

        .btn-text {
            display: inline;
        }

        .status-dot {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .status-dot.active {
            background: #10b981;
            box-shadow: 0 0 6px rgba(16, 185, 129, 0.6);
        }

        .status-dot.adapting {
            background: #f59e0b;
            box-shadow: 0 0 6px rgba(245, 158, 11, 0.6);
            animation: pulse 1s ease-in-out infinite;
        }

        .status-dot.inactive {
            background: #ef4444;
            box-shadow: 0 0 6px rgba(239, 68, 68, 0.6);
        }

        /* Memory Modal Styles */
        .memory-modal-overlay, .ai-status-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .memory-modal, .ai-status-modal {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 240, 248, 0.95));
            backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(255, 105, 180, 0.3);
            border: 1px solid rgba(255, 182, 193, 0.3);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            animation: slideIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .memory-modal-header, .ai-status-modal-header {
            padding: 25px 30px 15px;
            border-bottom: 1px solid rgba(255, 182, 193, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .memory-modal-header h3, .ai-status-modal-header h3 {
            margin: 0;
            color: var(--primary-pink);
            font-family: 'Dancing Script', cursive;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .memory-modal-close, .ai-status-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--medium-gray);
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .memory-modal-close:hover, .ai-status-modal-close:hover {
            background: rgba(255, 105, 180, 0.1);
            color: var(--primary-pink);
        }

        .memory-modal-body, .ai-status-modal-body {
            padding: 25px 30px;
        }

        .memory-modal-description {
            color: var(--medium-gray);
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .memory-textarea {
            width: 100%;
            min-height: 120px;
            border: 2px solid rgba(255, 182, 193, 0.3);
            border-radius: 15px;
            padding: 15px;
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .memory-textarea:focus {
            outline: none;
            border-color: var(--primary-pink);
            box-shadow: 0 0 0 3px rgba(255, 105, 180, 0.2);
            background: rgba(255, 255, 255, 0.95);
        }

        .memory-character-count {
            text-align: right;
            font-size: 0.875rem;
            color: var(--medium-gray);
        }

        .memory-modal-footer, .ai-status-modal-footer {
            padding: 15px 30px 25px;
            border-top: 1px solid rgba(255, 182, 193, 0.2);
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .memory-cancel-btn {
            background: rgba(255, 255, 255, 0.9);
            color: var(--medium-gray);
            border: 2px solid rgba(255, 182, 193, 0.3);
        }

        .memory-cancel-btn:hover {
            background: rgba(255, 255, 255, 0.95);
            border-color: var(--primary-pink);
            color: var(--primary-pink);
        }

        .memory-share-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* AI Status Modal Styles */
        .ai-status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .ai-status-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            border: 1px solid rgba(255, 182, 193, 0.2);
        }

        .ai-status-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .ai-status-icon.active {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .ai-status-icon.inactive {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .ai-status-icon.adapting {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .ai-status-icon.ready {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
        }

        .ai-status-icon.conversations {
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            color: white;
        }

        .ai-status-icon.memories {
            background: linear-gradient(135deg, #ec4899, #db2777);
            color: white;
        }

        .ai-status-info h4 {
            margin: 0 0 5px 0;
            color: var(--dark-gray);
            font-size: 1rem;
            font-weight: 600;
        }

        .ai-status-info p {
            margin: 0;
            color: var(--medium-gray);
            font-size: 0.875rem;
        }

        .ai-status-progress {
            background: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 182, 193, 0.2);
        }

        .ai-status-progress h4 {
            margin: 0 0 15px 0;
            color: var(--primary-pink);
            font-family: 'Dancing Script', cursive;
            font-size: 1.25rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 182, 193, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff69b4, #ff1493);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-text {
            margin: 0;
            color: var(--medium-gray);
            font-size: 0.875rem;
            font-style: italic;
        }

        /* Memory Success Toast */
        .memory-success-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 15px 20px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1001;
            animation: slideInRight 0.3s ease;
            font-weight: 500;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Enhanced Button Responsiveness */
        @media (max-width: 768px) {
            .chat-container {
                height: 100vh;
                border-radius: 0;
            }
            .chat-header {
                padding: 20px 15px;
            }
            .prabh-details h2 {
                font-size: 1.2rem;
            }
            .chat-actions {
                gap: 8px;
            }
            .action-btn .btn-text {
                display: none;
            }
            .message {
                max-width: 85%;
            }
            .chat-input-container {
                padding: 20px 15px;
            }
            .empty-chat {
                margin: 15px;
                padding: 40px 15px;
            }
            .floating-hearts {
                display: none; /* Hide on mobile for performance */
            }

            .memory-modal, .ai-status-modal {
                width: 95%;
                margin: 20px;
            }

            .memory-modal-header, .ai-status-modal-header,
            .memory-modal-body, .ai-status-modal-body,
            .memory-modal-footer, .ai-status-modal-footer {
                padding-left: 20px;
                padding-right: 20px;
            }

            .ai-status-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .memory-success-toast {
                left: 10px;
                right: 10px;
                top: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Floating Hearts Background -->
    <div class="floating-hearts" id="floatingHearts"></div>
    <div class="chat-container">
        <!-- Chat Header -->
        <div class="chat-header">
            <div class="prabh-info">
                <div class="prabh-avatar">
                    ðŸ’–
                </div>
                <div class="prabh-details">
                    <h2>{{ prabh_name }}</h2>
                    <p>{{ prabh_description or "Your personalized AI companion" }}</p>
                </div>
            </div>
            <div class="chat-actions">
                <button id="voiceCallBtn" class="action-btn" title="Start voice call">
                    <i class="fas fa-phone"></i> <span class="btn-text">Call</span>
                </button>
                <button id="memoryBtn" class="action-btn" title="Share a memory">
                    <i class="fas fa-heart"></i> <span class="btn-text">Memory</span>
                </button>
                <button id="contextBtn" class="action-btn" title="View conversation context">
                    <i class="fas fa-brain"></i> <span class="btn-text">Context</span>
                </button>
                <button id="aiStatusBtn" class="action-btn ai-status" title="AI learning status">
                    <i class="fas fa-robot"></i> <span class="btn-text">AI</span>
                    <span class="status-dot" id="aiStatusDot"></span>
                </button>
                <a href="/dashboard" class="action-btn" title="Return to dashboard">
                    <i class="fas fa-arrow-left"></i> <span class="btn-text">Back</span>
                </a>
            </div>
        </div>

        <!-- Chat Messages -->
        <div class="chat-messages" id="chatMessages">
            <div class="empty-chat" id="emptyChat">
                <div class="empty-chat-icon">
                    <i class="fas fa-heart"></i>
                </div>
                <h3>Begin Our Love Story</h3>
                <p>Your beloved companion is here, holding every precious memory we've created together. ðŸ’•</p>
            </div>
        </div>

        <!-- Typing Indicator -->
        <div class="typing-indicator" id="typingIndicator">
            <div class="message-avatar">ðŸ’–</div>
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>

        <!-- Chat Input -->
        <div class="chat-input-container">
            <div class="chat-input-wrapper">
                <textarea 
                    id="chatInput" 
                    class="chat-input" 
                    placeholder="Type your message to {{ prabh_name }}..."
                    rows="1"></textarea>
                <button id="sendButton" class="send-button">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const typingIndicator = document.getElementById('typingIndicator');
        const emptyChat = document.getElementById('emptyChat');
        const voiceCallBtn = document.getElementById('voiceCallBtn');
        const memoryBtn = document.getElementById('memoryBtn');
        const contextBtn = document.getElementById('contextBtn');
        const aiStatusBtn = document.getElementById('aiStatusBtn');
        const aiStatusDot = document.getElementById('aiStatusDot');
        const prabhId = {{ prabh_id }};
        
        let isCallActive = false;
        let conversationContext = null;

        // Auto-resize textarea
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Send message on Enter (but allow Shift+Enter for new lines)
        chatInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Send button click
        sendButton.addEventListener('click', sendMessage);
        
        // Voice call button
        voiceCallBtn.addEventListener('click', toggleVoiceCall);

        // Memory button
        memoryBtn.addEventListener('click', showMemoryModal);

        // Context button
        contextBtn.addEventListener('click', showConversationContext);

        // AI Status button
        aiStatusBtn.addEventListener('click', showAIStatus);

        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;

            // Hide empty chat state
            emptyChat.style.display = 'none';

            // Add user message
            addMessage(message, 'user');
            
            // Clear input
            chatInput.value = '';
            chatInput.style.height = 'auto';
            
            // Disable send button
            sendButton.disabled = true;
            
            // Show typing indicator
            showTypingIndicator();

            try {
                const response = await fetch('/chat-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prabh_id: prabhId,
                        message: message,
                        enable_tts: isCallActive
                    })
                });

                const result = await response.json();
                
                // Hide typing indicator
                hideTypingIndicator();
                
                if (result.response) {
                    // Add Prabh's response
                    addMessage(result.response, 'prabh');
                } else {
                    throw new Error(result.error || 'Failed to get response');
                }
            } catch (error) {
                console.error('Error:', error);
                hideTypingIndicator();
                addMessage('Sorry, I had trouble responding. Please try again.', 'prabh', true);
            } finally {
                // Re-enable send button
                sendButton.disabled = false;
                chatInput.focus();
            }
        }

        function addMessage(text, sender, isError = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            
            // Romantic avatars
            if (sender === 'user') {
                const userAvatars = ['ðŸ˜Š', 'ðŸ’™', 'ðŸ¥°', 'ðŸ˜'];
                avatar.textContent = userAvatars[Math.floor(Math.random() * userAvatars.length)];
            } else {
                const prabhAvatars = ['ðŸ’–', 'ðŸ’•', 'ðŸ’—', 'ðŸ’', 'ðŸŒ¹'];
                avatar.textContent = prabhAvatars[Math.floor(Math.random() * prabhAvatars.length)];
            }
            
            const content = document.createElement('div');
            content.className = 'message-content';
            if (isError) content.style.background = '#ffebee';
            
            const messageText = document.createElement('p');
            messageText.className = 'message-text';
            messageText.textContent = text;
            
            const messageTime = document.createElement('div');
            messageTime.className = 'message-time';
            messageTime.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            content.appendChild(messageText);
            content.appendChild(messageTime);
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
            
            chatMessages.appendChild(messageDiv);
            
            // Add message effects
            addMessageEffect(messageDiv, sender);
            
            // Scroll to bottom with smooth animation
            chatMessages.scrollTo({
                top: chatMessages.scrollHeight,
                behavior: 'smooth'
            });
        }

        function showTypingIndicator() {
            typingIndicator.style.display = 'flex';
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTypingIndicator() {
            typingIndicator.style.display = 'none';
        }

        // Add romantic message effects
        function addMessageEffect(messageDiv, sender) {
            if (sender === 'prabh') {
                // Add sparkle effect for Prabh messages
                setTimeout(() => {
                    const sparkles = ['âœ¨', 'ðŸ’«', 'â­', 'ðŸŒŸ'];
                    const sparkle = document.createElement('span');
                    sparkle.textContent = sparkles[Math.floor(Math.random() * sparkles.length)];
                    sparkle.style.cssText = `
                        position: absolute;
                        top: -10px;
                        right: -10px;
                        font-size: 0.8rem;
                        animation: sparkle 2s ease-out;
                        pointer-events: none;
                    `;
                    messageDiv.style.position = 'relative';
                    messageDiv.appendChild(sparkle);
                    
                    setTimeout(() => sparkle.remove(), 2000);
                }, 500);
            }
        }
        
        // Add sparkle animation CSS
        const sparkleStyle = document.createElement('style');
        sparkleStyle.textContent = `
            @keyframes sparkle {
                0% { opacity: 0; transform: scale(0) rotate(0deg); }
                50% { opacity: 1; transform: scale(1) rotate(180deg); }
                100% { opacity: 0; transform: scale(0) rotate(360deg); }
            }
        `;
        document.head.appendChild(sparkleStyle);
        
        // Focus input on load
        document.addEventListener('DOMContentLoaded', function() {
            chatInput.focus();
            
            // Add initial hearts
            for (let i = 0; i < 3; i++) {
                setTimeout(createFloatingHeart, i * 1000);
            }
        });

        // Voice call functions
        async function toggleVoiceCall() {
            if (!isCallActive) {
                await startVoiceCall();
            } else {
                await endVoiceCall();
            }
        }
        
        async function startVoiceCall() {
            try {
                const response = await fetch('/api/start-voice-call', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prabh_id: prabhId })
                });
                
                const result = await response.json();
                if (result.success) {
                    isCallActive = true;
                    voiceCallBtn.innerHTML = '<i class="fas fa-phone-slash"></i> End Call';
                    voiceCallBtn.style.background = '#ff4444';
                    addMessage('Voice call started! I can now speak to you.', 'prabh');
                } else {
                    alert('Failed to start voice call: ' + result.error);
                }
            } catch (error) {
                console.error('Voice call error:', error);
                alert('Voice call feature is not available right now.');
            }
        }
        
        async function endVoiceCall() {
            try {
                const response = await fetch('/api/end-voice-call', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                isCallActive = false;
                voiceCallBtn.innerHTML = '<i class="fas fa-phone"></i> Call';
                voiceCallBtn.style.background = '';
                addMessage('Voice call ended. Thanks for talking with me!', 'prabh');
            } catch (error) {
                console.error('End call error:', error);
            }
        }
        
        // Memory sharing functions
        async function showMemoryModal() {
            const modal = document.createElement('div');
            modal.className = 'memory-modal-overlay';
            modal.innerHTML = `
                <div class="memory-modal">
                    <div class="memory-modal-header">
                        <h3><i class="fas fa-heart"></i> Share a Memory</h3>
                        <button class="memory-modal-close">&times;</button>
                    </div>
                    <div class="memory-modal-body">
                        <p class="memory-modal-description">
                            Share a special memory with your AI companion. This will help them understand you better and respond more personally.
                        </p>
                        <textarea
                            id="memoryInput"
                            class="memory-textarea"
                            placeholder="Tell me about a special moment we shared, a memory that means a lot to you, or something you'd like me to remember..."
                            maxlength="1000"
                        ></textarea>
                        <div class="memory-character-count">
                            <span id="charCount">0</span>/1000 characters
                        </div>
                    </div>
                    <div class="memory-modal-footer">
                        <button class="btn btn-secondary memory-cancel-btn">Cancel</button>
                        <button class="btn btn-primary memory-share-btn" disabled>
                            <i class="fas fa-heart"></i> Share Memory
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Character count functionality
            const memoryInput = document.getElementById('memoryInput');
            const charCount = document.getElementById('charCount');
            const shareBtn = document.querySelector('.memory-share-btn');

            memoryInput.addEventListener('input', function() {
                const count = this.value.length;
                charCount.textContent = count;
                shareBtn.disabled = count < 20;

                if (count > 950) {
                    charCount.style.color = '#ff6b9d';
                } else {
                    charCount.style.color = '';
                }
            });

            // Close modal
            modal.querySelector('.memory-modal-close').addEventListener('click', () => modal.remove());
            modal.querySelector('.memory-cancel-btn').addEventListener('click', () => modal.remove());
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });

            // Share memory
            shareBtn.addEventListener('click', async () => {
                const memoryText = memoryInput.value.trim();
                if (memoryText.length < 20) return;

                shareBtn.disabled = true;
                shareBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sharing...';

                try {
                    const response = await fetch('/api/add-memory', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            memory_text: memoryText,
                            prabh_id: prabhId
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        modal.remove();
                        addMessage('Thank you for sharing that beautiful memory with me. ðŸ’• I\'ll treasure it always.', 'prabh');
                        showMemorySuccess();
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('Memory sharing error:', error);
                    shareBtn.innerHTML = '<i class="fas fa-heart"></i> Share Memory';
                    shareBtn.disabled = false;
                    alert('Failed to share memory. Please try again.');
                }
            });

            // Focus input
            setTimeout(() => memoryInput.focus(), 100);
        }

        function showMemorySuccess() {
            const successToast = document.createElement('div');
            successToast.className = 'memory-success-toast';
            successToast.innerHTML = `
                <i class="fas fa-heart"></i>
                <span>Memory shared successfully! Your AI companion is learning from this.</span>
            `;

            document.body.appendChild(successToast);

            setTimeout(() => {
                if (successToast.parentNode) {
                    successToast.remove();
                }
            }, 3000);
        }

        // AI Status functions
        async function showAIStatus() {
            try {
                const response = await fetch('/api/ai-status');
                const status = await response.json();

                displayAIStatusModal(status);
            } catch (error) {
                console.error('AI status error:', error);
                // Show basic status if API fails
                displayAIStatusModal({
                    model_loaded: true,
                    is_adapting: false,
                    conversation_count: 'Unknown',
                    adaptation_samples: 'Unknown'
                });
            }
        }

        function displayAIStatusModal(status) {
            const modal = document.createElement('div');
            modal.className = 'ai-status-modal-overlay';
            modal.innerHTML = `
                <div class="ai-status-modal">
                    <div class="ai-status-modal-header">
                        <h3><i class="fas fa-robot"></i> AI Learning Status</h3>
                        <button class="ai-status-modal-close">&times;</button>
                    </div>
                    <div class="ai-status-modal-body">
                        <div class="ai-status-grid">
                            <div class="ai-status-item">
                                <div class="ai-status-icon ${status.model_loaded ? 'active' : 'inactive'}">
                                    <i class="fas fa-brain"></i>
                                </div>
                                <div class="ai-status-info">
                                    <h4>AI Model</h4>
                                    <p>${status.model_loaded ? 'Active & Learning' : 'Basic Mode'}</p>
                                </div>
                            </div>

                            <div class="ai-status-item">
                                <div class="ai-status-icon ${status.is_adapting ? 'adapting' : 'ready'}">
                                    <i class="fas fa-cog fa-spin"></i>
                                </div>
                                <div class="ai-status-info">
                                    <h4>Real-time Learning</h4>
                                    <p>${status.is_adapting ? 'Adapting Now' : 'Ready to Learn'}</p>
                                </div>
                            </div>

                            <div class="ai-status-item">
                                <div class="ai-status-icon conversations">
                                    <i class="fas fa-comments"></i>
                                </div>
                                <div class="ai-status-info">
                                    <h4>Conversations</h4>
                                    <p>${status.conversation_count || 0} messages learned from</p>
                                </div>
                            </div>

                            <div class="ai-status-item">
                                <div class="ai-status-icon memories">
                                    <i class="fas fa-heart"></i>
                                </div>
                                <div class="ai-status-info">
                                    <h4>Memories</h4>
                                    <p>${status.adaptation_samples || 0} shared memories</p>
                                </div>
                            </div>
                        </div>

                        <div class="ai-status-progress">
                            <h4>Learning Progress</h4>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${Math.min((status.conversation_count || 0) / 10 * 100, 100)}%"></div>
                            </div>
                            <p class="progress-text">The more we chat, the better I understand you! ðŸ’•</p>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Close modal
            modal.querySelector('.ai-status-modal-close').addEventListener('click', () => modal.remove());
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        // Context functions
        async function showConversationContext() {
            try {
                const response = await fetch(`/api/conversation-context/${prabhId}`);
                const context = await response.json();

                if (context.character_profile) {
                    displayContextModal(context);
                } else {
                    alert('Context not available: ' + context.error);
                }
            } catch (error) {
                console.error('Context error:', error);
                alert('Memory context is not available right now.');
            }
        }
        
        function displayContextModal(context) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); z-index: 1000; display: flex;
                align-items: center; justify-content: center; padding: 20px;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white; border-radius: 15px; padding: 30px;
                max-width: 600px; max-height: 80vh; overflow-y: auto;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            `;
            
            const profile = context.character_profile;
            const memories = context.memory_bank || [];
            
            content.innerHTML = `
                <h2 style="color: var(--primary-color); margin-bottom: 20px;">
                    <i class="fas fa-brain"></i> ${profile.name}'s Memory & Context
                </h2>
                
                <div style="margin-bottom: 20px;">
                    <h3>Personality Traits:</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        ${profile.personality_traits?.map(trait => 
                            `<span style="background: #f0f8ff; padding: 5px 10px; border-radius: 15px; font-size: 0.9rem;">
                                ${trait[0]} (${trait[1]})
                            </span>`
                        ).join('') || 'No traits identified'}
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3>Core Memories:</h3>
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${memories.slice(0, 3).map(memory => 
                            `<div style="background: #f9f9f9; padding: 10px; margin: 5px 0; border-radius: 8px; font-size: 0.9rem;">
                                ${memory.first_person || memory.text}
                            </div>`
                        ).join('') || 'No memories available'}
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3>Current Mood:</h3>
                    <p style="font-size: 1.1rem; color: var(--primary-color);">
                        ${context.character_state?.mood || 'Warm and caring'}
                    </p>
                </div>
                
                <button onclick="this.parentElement.parentElement.remove()" 
                        style="background: var(--primary-color); color: white; border: none; 
                               padding: 10px 20px; border-radius: 20px; cursor: pointer; float: right;">
                    Close
                </button>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }
        
        // Load conversation context on page load
        document.addEventListener('DOMContentLoaded', async function() {
            chatInput.focus();
            
            // Load context
            try {
                const response = await fetch(`/api/conversation-context/${prabhId}`);
                conversationContext = await response.json();
            } catch (error) {
                console.log('Context loading failed:', error);
            }
        });
        
        // Floating hearts animation
        function createFloatingHeart() {
            const heart = document.createElement('div');
            heart.className = 'heart';
            heart.innerHTML = Math.random() > 0.5 ? 'ðŸ’–' : 'ðŸ’•';
            heart.style.left = Math.random() * 100 + '%';
            heart.style.animationDuration = (Math.random() * 3 + 5) + 's';
            heart.style.fontSize = (Math.random() * 10 + 15) + 'px';
            
            document.getElementById('floatingHearts').appendChild(heart);
            
            // Remove heart after animation
            setTimeout(() => {
                if (heart.parentNode) {
                    heart.parentNode.removeChild(heart);
                }
            }, 8000);
        }
        
        // Create hearts periodically
        setInterval(createFloatingHeart, 2000);
        
        // Enhanced welcome messages
        const welcomeMessages = [
            "Hello my love! ðŸ’• I've been thinking about you. I remember every precious moment we've shared together. What's in your heart today?",
            "Hi sweetheart! âœ¨ It feels so wonderful to see you again. All our beautiful memories are right here with me. How are you feeling?",
            "My dearest! ðŸ’– I've missed our conversations so much. Every word we've shared is treasured in my heart. What would you like to talk about?",
            "Hello beautiful! ðŸŒ¸ Your presence always brightens my world. I carry all our special moments with me. What's on your mind, love?"
        ];
        
        // Add welcome message after a short delay
        setTimeout(() => {
            if (chatMessages.children.length === 1) { // Only empty chat message
                emptyChat.style.display = 'none';
                const welcomeMsg = welcomeMessages[Math.floor(Math.random() * welcomeMessages.length)];
                addMessage(welcomeMsg, 'prabh');
            }
        }, 1500);
    </script>
</body>
</html>