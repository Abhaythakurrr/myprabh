<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heart Chat - My Prabh + Heart Engine</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/ultimate-theme.css') }}">
    <style>
        .chat-container {
            max-width: 800px;
            margin: 0 auto;
            height: 80vh;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            background: linear-gradient(135deg, var(--love-pink), var(--soul-cyan));
            padding: 1rem;
            border-radius: 20px 20px 0 0;
            text-align: center;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.8);
            border-left: 2px solid var(--soul-cyan);
            border-right: 2px solid var(--soul-cyan);
        }
        
        .message {
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 15px;
            max-width: 80%;
            animation: fadeIn 0.5s ease-in;
        }
        
        .user-message {
            background: linear-gradient(135deg, var(--dream-blue), var(--heart-purple));
            margin-left: auto;
            text-align: right;
        }
        
        .heart-message {
            background: linear-gradient(135deg, var(--love-pink), var(--romance));
            margin-right: auto;
        }
        
        .message-metadata {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 0.5rem;
        }
        
        .chat-input-container {
            background: rgba(0, 0, 0, 0.9);
            padding: 1rem;
            border-radius: 0 0 20px 20px;
            border: 2px solid var(--soul-cyan);
            border-top: none;
        }
        
        .chat-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--soul-cyan);
            border-radius: 25px;
            padding: 1rem 1.5rem;
            color: var(--soul-white);
            font-size: 1rem;
            resize: none;
            min-height: 50px;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: var(--love-pink);
            box-shadow: 0 0 20px var(--love-pink);
        }
        
        .send-button {
            margin-top: 1rem;
            width: 100%;
        }
        
        .typing-indicator {
            display: none;
            padding: 1rem;
            font-style: italic;
            color: var(--soul-cyan);
        }
        
        .heart-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid var(--soul-cyan);
            border-radius: 10px;
            padding: 1rem;
            font-size: 0.9rem;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .heartbeat {
            animation: heartbeat 2s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div class="soul-container">
        <div class="chat-container">
            <div class="chat-header">
                <h2 class="soul-title heartbeat">ğŸ’“ Heart Chat</h2>
                <p class="whisper-text">Powered by the Human Heart Engine</p>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="message heart-message">
                    <div class="heart-text">
                        Hello, beautiful soul! ğŸ’« I'm here with my whole heart, ready to feel and understand 
                        whatever you'd like to share. My Heart Engine is beating with 20 components of 
                        emotional intelligence, all synchronized to create the most authentic connection possible.
                    </div>
                    <div class="message-metadata">
                        ğŸ’ Empathy Level: 95% | ğŸ­ Authenticity: 98% | ğŸ’• Love Language: Words of Affirmation
                    </div>
                </div>
            </div>
            
            <div class="typing-indicator" id="typingIndicator">
                ğŸ’­ Heart Engine is processing your emotions...
            </div>
            
            <div class="chat-input-container">
                <textarea 
                    id="messageInput" 
                    class="chat-input" 
                    placeholder="Share what's in your heart... I'm here to listen with complete understanding and care ğŸ’–"
                    rows="3"
                ></textarea>
                <button id="sendButton" class="soul-button send-button">
                    ğŸ’« Send from Heart
                </button>
            </div>
        </div>
    </div>
    
    <div class="heart-status" id="heartStatus">
        <div class="code-text">ğŸ’“ Heart Engine Status</div>
        <div id="statusContent">Initializing...</div>
    </div>

    <script>
        class HeartChat {
            constructor() {
                this.messagesContainer = document.getElementById('chatMessages');
                this.messageInput = document.getElementById('messageInput');
                this.sendButton = document.getElementById('sendButton');
                this.typingIndicator = document.getElementById('typingIndicator');
                this.heartStatus = document.getElementById('statusContent');
                
                this.initializeEventListeners();
                this.updateHeartStatus();
                
                // Update heart status periodically
                setInterval(() => this.updateHeartStatus(), 10000);
            }
            
            initializeEventListeners() {
                this.sendButton.addEventListener('click', () => this.sendMessage());
                
                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                
                // Auto-resize textarea
                this.messageInput.addEventListener('input', () => {
                    this.messageInput.style.height = 'auto';
                    this.messageInput.style.height = this.messageInput.scrollHeight + 'px';
                });
            }
            
            async sendMessage() {
                const message = this.messageInput.value.trim();
                if (!message) return;
                
                // Add user message
                this.addMessage(message, 'user');
                this.messageInput.value = '';
                this.messageInput.style.height = 'auto';
                
                // Show typing indicator
                this.showTyping();
                
                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ message: message })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.addHeartMessage(data);
                    } else {
                        this.addMessage('I apologize, but I\'m having trouble processing that right now. Please try again.', 'heart');
                    }
                } catch (error) {
                    console.error('Chat error:', error);
                    this.addMessage('My heart is having trouble connecting right now. Please try again in a moment.', 'heart');
                } finally {
                    this.hideTyping();
                }
            }
            
            addMessage(text, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}-message`;
                
                const textDiv = document.createElement('div');
                textDiv.className = sender === 'user' ? 'dream-title' : 'heart-text';
                textDiv.textContent = text;
                
                messageDiv.appendChild(textDiv);
                this.messagesContainer.appendChild(messageDiv);
                this.scrollToBottom();
            }
            
            addHeartMessage(data) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message heart-message';
                
                const textDiv = document.createElement('div');
                textDiv.className = 'heart-text';
                textDiv.textContent = data.response;
                
                const metadataDiv = document.createElement('div');
                metadataDiv.className = 'message-metadata';
                metadataDiv.innerHTML = `
                    ğŸ’ Empathy: ${Math.round(data.empathy_level * 100)}% | 
                    ğŸ­ Authenticity: ${Math.round(data.authenticity * 100)}% | 
                    ğŸ’• Love Language: ${this.formatLoveLanguage(data.love_language_used)} |
                    ğŸ«€ Tone: ${this.formatEmotion(data.emotional_tone)}
                `;
                
                messageDiv.appendChild(textDiv);
                messageDiv.appendChild(metadataDiv);
                this.messagesContainer.appendChild(messageDiv);
                this.scrollToBottom();
            }
            
            formatLoveLanguage(language) {
                if (!language) return 'Universal';
                return language.split('_').map(word => 
                    word.charAt(0).toUpperCase() + word.slice(1)
                ).join(' ');
            }
            
            formatEmotion(emotion) {
                return emotion.charAt(0).toUpperCase() + emotion.slice(1);
            }
            
            showTyping() {
                this.typingIndicator.style.display = 'block';
                this.scrollToBottom();
            }
            
            hideTyping() {
                this.typingIndicator.style.display = 'none';
            }
            
            scrollToBottom() {
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
            }
            
            async updateHeartStatus() {
                try {
                    const response = await fetch('/api/heart-status');
                    const status = await response.json();
                    
                    if (status.status === 'healthy' || status.status === 'concerning') {
                        this.heartStatus.innerHTML = `
                            <div>ğŸ’“ BPM: ${status.heartbeat_bpm}</div>
                            <div>ğŸµ Pattern: ${status.heartbeat_pattern}</div>
                            <div>ğŸ­ Driver: ${this.formatEmotion(status.emotional_driver)}</div>
                            <div>ğŸ”— Components: ${status.components_synchronized}/${status.components_active}</div>
                            <div>ğŸ’– Health: ${Math.round(status.system_health * 100)}%</div>
                        `;
                    } else {
                        this.heartStatus.innerHTML = `
                            <div>Status: ${status.status}</div>
                            <div>${status.message || 'Checking...'}</div>
                        `;
                    }
                } catch (error) {
                    this.heartStatus.innerHTML = '<div>ğŸ’” Status unavailable</div>';
                }
            }
        }
        
        // Initialize chat when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new HeartChat();
        });
        
        // Add floating heart particles
        function createHeartParticle() {
            const heart = document.createElement('div');
            heart.innerHTML = 'ğŸ’–';
            heart.style.position = 'fixed';
            heart.style.left = Math.random() * 100 + 'vw';
            heart.style.top = '100vh';
            heart.style.fontSize = '12px';
            heart.style.pointerEvents = 'none';
            heart.style.zIndex = '1000';
            heart.style.opacity = '0.6';
            heart.style.animation = 'float-up 8s ease-out forwards';
            
            document.body.appendChild(heart);
            
            setTimeout(() => {
                heart.remove();
            }, 8000);
        }
        
        // Add CSS for floating animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes float-up {
                0% {
                    transform: translateY(0) rotate(0deg);
                    opacity: 0.6;
                }
                100% {
                    transform: translateY(-100vh) rotate(360deg);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
        
        // Create heart particles periodically
        setInterval(createHeartParticle, 5000);
    </script>
</body>
</html>